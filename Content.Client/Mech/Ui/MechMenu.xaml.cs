using Content.Client.UserInterface.Controls;
using Content.Client.UserInterface.Fragments;
using Content.Shared.Mech.Components;
using Content.Shared.Mech;
using Content.Shared.Atmos;
using Content.Shared.Mech.Equipment.Components;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using Robust.Client.UserInterface.Controls;
using System.Linq;
using static Robust.Client.UserInterface.Controls.BaseButton;
using Robust.Client.UserInterface;
using Content.Shared.Mech.EntitySystems;

namespace Content.Client.Mech.Ui;

[GenerateTypedNameReferences]
public sealed partial class MechMenu : FancyWindow
{
    [Dependency] private readonly IEntityManager _ent = default!;

    private EntityUid _mech;
    private bool _hasAccess = true;
    private bool _pilotPresent = false;

    public event Action<EntityUid>? OnRemoveButtonPressed;
    public event Action<EntityUid>? OnRemoveModuleButtonPressed;
    public event Action? OnAccessDeniedAttempt;

    public Action<string>? NameChanged;

    public event Action<bool>? OnAirtightChanged;
    public event Action<bool>? OnFanToggle;
    public event Action<bool>? OnFilterToggle;
    public event Action? OnDnaLockRegister;
    public event Action? OnDnaLockToggle;
    public event Action? OnDnaLockReset;
    public event Action? OnCardLockRegister;
    public event Action? OnCardLockToggle;
    public event Action? OnCardLockReset;
    public event Action? OnCabinPurge;

    public MechMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        AirtightButton.OnToggled += args => { if (!CheckAccess()) { OnAccessDeniedPing(); return; } OnAirtightChanged?.Invoke(args.Pressed); };
        CabinPurgeButton.OnPressed += _ => { if (!CheckAccess()) { OnAccessDeniedPing(); return; } OnCabinPurge?.Invoke(); };

        DnaLockRegisterButton.OnPressed += args =>
        {
            var (isRegistered, _, _) = GetCurrentLockState(MechLockType.Dna);
            if (!isRegistered)
                OnLockAction(args, OnDnaLockRegister, DnaLockRegisterButton);
        };
        DnaLockBlockButton.OnPressed += args =>
        {
            var (isRegistered, _, _) = GetCurrentLockState(MechLockType.Dna);
            if (isRegistered)
                OnLockAction(args, OnDnaLockToggle, DnaLockBlockButton);
        };
        DnaLockResetButton.OnPressed += args => {
            OnLockAction(args, OnDnaLockReset, DnaLockResetButton);
        };

        CardLockRegisterButton.OnPressed += args =>
        {
            var (isRegistered, _, _) = GetCurrentLockState(MechLockType.Card);
            if (!isRegistered)
                OnLockAction(args, OnCardLockRegister, CardLockRegisterButton);
        };
        CardLockBlockButton.OnPressed += args =>
        {
            var (isRegistered, _, _) = GetCurrentLockState(MechLockType.Card);
            if (isRegistered)
                OnLockAction(args, OnCardLockToggle, CardLockBlockButton);
        };
        CardLockResetButton.OnPressed += args => {
            OnLockAction(args, OnCardLockReset, CardLockResetButton);
        };

        FanOffButton.OnToggled += args =>
        {
            if (args.Pressed)
            {
                FanOnButton.Pressed = false;
                if (!CheckAccess()) { OnAccessDeniedPing(); return; }
                OnFanToggle?.Invoke(false);
            }
        };

        FanOnButton.OnToggled += args =>
        {
            if (args.Pressed)
            {
                FanOffButton.Pressed = false;
                if (!CheckAccess()) { OnAccessDeniedPing(); return; }
                OnFanToggle?.Invoke(true);
            }
        };

        // Raise filter toggle event to be handled by BUI
        FilterEnabledCheck.OnToggled += args =>
        {
            if (!CheckAccess()) { OnAccessDeniedPing(); return; }
            OnFilterToggle?.Invoke(args.Pressed);
        };
    }

    private void OnAccessDeniedPing()
    {
        OnAccessDeniedAttempt?.Invoke();
    }

    private bool CheckAccess()
    {
        return _hasAccess;
    }

    public void SetEntity(EntityUid uid)
    {
        MechView.SetEntity(uid);
        _mech = uid;

        NameLabel.Text = _ent.GetComponent<MetaDataComponent>(_mech).EntityName;
    }

    public void UpdateMechStats()
    {
        if (!_ent.TryGetComponent<MechComponent>(_mech, out var mechComp))
            return;

        var integrityPercent = mechComp.Integrity / mechComp.MaxIntegrity;
        IntegrityDisplayBar.Value = integrityPercent.Float();
        IntegrityDisplay.Text = Loc.GetString("mech-integrity-display", ("amount", (integrityPercent * 100).Int()));

        if (mechComp.MaxEnergy != 0f)
        {
            var energyPercent = mechComp.Energy / mechComp.MaxEnergy;
            EnergyDisplayBar.Value = energyPercent.Float();
            EnergyDisplay.Text = Loc.GetString("mech-energy-display", ("amount", (energyPercent * 100).Int()));
        }
        else
        {
            EnergyDisplayBar.Value = 0f;
            EnergyDisplay.Text = Loc.GetString("mech-energy-missing");
        }

        var equipUsed = mechComp.EquipmentContainer.ContainedEntities.Count;
        SlotDisplay.Text = Loc.GetString("mech-equipment-slot-display",
            ("used", equipUsed), ("max", mechComp.MaxEquipmentAmount));

        // Module capacity label uses consumed space out of total
        var usedSpace = 0;
        foreach (var ent in mechComp.ModuleContainer.ContainedEntities)
            usedSpace += _ent.GetComponentOrNull<MechModuleComponent>(ent)?.Size ?? 1;
        ModuleSlotDisplay.Text = Loc.GetString("mech-module-slot-display",
            ("used", usedSpace), ("max", mechComp.MaxModuleSpace));
    }

    public void UpdateState(MechBoundUiState state)
    {
        _lastState = state;

        // Toggle fan controls visibility based on module presence
        FanOnButton.Visible = state.HasFanModule;
        FanOffButton.Visible = state.HasFanModule;
        FanStatusLabel.Visible = state.HasFanModule;
        FilterEnabledCheck.Visible = state.HasFanModule;
        FanMissingLabel.Visible = !state.HasFanModule;

        CabinPurgeButton.Text = Loc.GetString("mech-cabin-purge");

        // Update airtight button state
        if (AirtightButton.Pressed != state.IsAirtight)
            AirtightButton.Pressed = state.IsAirtight;

        // Update fan button states
        if (state.HasFanModule)
        {
            if (FanOffButton.Pressed != !state.FanActive)
                FanOffButton.Pressed = !state.FanActive;
            if (FanOnButton.Pressed != state.FanActive)
                FanOnButton.Pressed = state.FanActive;

            if (FilterEnabledCheck.Pressed != state.FilterEnabled)
                FilterEnabledCheck.Pressed = state.FilterEnabled;

            // Update fan status display
            UpdateFanStatusDisplay(state.FanState);
        }

        // Update cabin gas level (always show)
        CabinGasLabel.Text = Loc.GetString("mech-cabin-pressure-level", ("level", $"{state.CabinGasLevel:F1}"));

        // Update tank pressure (or N/A if no cylinder)
        if (state.HasGasModule)
            TankPressureLabel.Text = Loc.GetString("mech-tank-pressure-level", ("state", "ok"), ("pressure", state.TankPressure.ToString("0.##")));
        else
            TankPressureLabel.Text = Loc.GetString("mech-tank-pressure-level", ("state", "na"));

        // Update module capacity label from state too (kept in sync even if local calc misses)
        ModuleSlotDisplay.Text = Loc.GetString("mech-module-slot-display",
            ("used", state.ModuleSpaceUsed), ("max", state.ModuleSpaceMax));

        UpdateLockButtons(state);
        UpdateLockInfoLabels(state);
    }

    private void UpdateFanStatusDisplay(MechFanState fanState)
    {
        var stateKey = fanState switch
        {
            MechFanState.Off => "off",
            MechFanState.On => "on",
            MechFanState.Idle => "idle"
        };
        var stateColorKey = fanState switch
        {
            MechFanState.Off => Color.Red,
            MechFanState.On => Color.Green,
            MechFanState.Idle => Color.Yellow
        };
        FanStatusLabel.Text = Loc.GetString("mech-fan-status", ("state", stateKey));
        FanStatusLabel.FontColorOverride = stateColorKey;
    }

    private void UpdateLockInfoLabels(MechBoundUiState state)
    {
        // Update DNA lock info
        if (state.DnaLockRegistered && !string.IsNullOrEmpty(state.OwnerDna))
        {
            DnaLockInfoLabel.Text = Loc.GetString("mech-lock-dna-info", ("dna", state.OwnerDna));
        }
        else
        {
            DnaLockInfoLabel.Text = Loc.GetString("mech-lock-not-set");
        }

        // Update Card lock info
        if (state.CardLockRegistered && !string.IsNullOrEmpty(state.OwnerJobTitle))
        {
            CardLockInfoLabel.Text = Loc.GetString("mech-lock-card-info", ("name", state.OwnerJobTitle));
        }
        else
        {
            CardLockInfoLabel.Text = Loc.GetString("mech-lock-not-set");
        }
    }

    private void UpdateLockButtons(MechBoundUiState state)
    {
        // DNA
        var (dnaRegistered, dnaActive, _) = GetLockState(state, MechLockType.Dna);
        DnaLockRegisterButton.Visible = !dnaRegistered;
        DnaLockBlockButton.Visible = dnaRegistered;
        DnaLockResetButton.Visible = dnaRegistered;
        DnaLockBlockButton.Text = Loc.GetString(dnaActive ? "mech-lock-deactivate" : "mech-lock-activate");
        DnaLockBlockButton.Pressed = dnaActive;

        // Card
        var (cardRegistered, cardActive, _) = GetLockState(state, MechLockType.Card);
        CardLockRegisterButton.Visible = !cardRegistered;
        CardLockBlockButton.Visible = cardRegistered;
        CardLockResetButton.Visible = cardRegistered;
        CardLockBlockButton.Text = Loc.GetString(cardActive ? "mech-lock-deactivate" : "mech-lock-activate");
        CardLockBlockButton.Pressed = cardActive;
    }

    private MechBoundUiState? _lastState;

    public void OverrideAccessAndRefresh(bool hasAccess)
    {
        _hasAccess = hasAccess;
        var isLocked = _lastState?.IsLocked ?? true;
        var noAccessActive = isLocked && !_hasAccess;
        SettingsGrid.Visible = !noAccessActive;
        SettingsNoAccessPanel.Visible = noAccessActive;
        AirtightButton.Disabled = noAccessActive;
        FanOnButton.Disabled = noAccessActive;
        FanOffButton.Disabled = noAccessActive;
        FilterEnabledCheck.Disabled = noAccessActive;
        CabinPurgeButton.Disabled = noAccessActive || (_lastState != null && !_lastState.CabinPurgeAvailable);
    }

    private (bool IsRegistered, bool IsActive, string? OwnerId) GetLockState(MechBoundUiState state, MechLockType lockType)
    {
        return lockType switch
        {
            MechLockType.Dna => (state.DnaLockRegistered, state.DnaLockActive, state.OwnerDna),
            MechLockType.Card => (state.CardLockRegistered, state.CardLockActive, state.OwnerJobTitle),
            _ => (false, false, null)
        };
    }

    private (bool IsRegistered, bool IsActive, string? OwnerId) GetCurrentLockState(MechLockType lockType)
    {
        if (_lastState == null)
            return (false, false, null);

        return GetLockState(_lastState, lockType);
    }

    private void OnLockAction(ButtonEventArgs args, Action? action, BaseButton button)
    {
        action?.Invoke();
        button.Pressed = false;
    }

    private void UpdateEntityListView<TComponent>(
        List<NetEntity>? entities,
        BoxContainer container,
        Func<MechComponent, IEnumerable<EntityUid>> getEntities,
        Func<EntityUid, int> getSize,
        Action<EntityUid> onRemove,
        Func<EntityUid, Control?>? getFragment = null)
        where TComponent : class
    {
        if (entities == null)
        {
            if (!_ent.TryGetComponent<MechComponent>(_mech, out var mechComp))
                return;
            entities = new List<NetEntity>();
            foreach (var ent in getEntities(mechComp))
                entities.Add(_ent.GetNetEntity(ent));
        }

        container.Children.Clear();
        foreach (var netEnt in entities)
        {
            var ent = _ent.GetEntity(netEnt);
            if (!_ent.TryGetComponent<MetaDataComponent>(ent, out var metaData))
                continue;
            var size = getSize(ent);
            var fragment = getFragment?.Invoke(ent);
            var control = new MechEquipmentControl(ent, metaData.EntityName, fragment, size);
            var entityToRemove = ent;
            control.OnRemoveButtonPressed += () => onRemove(entityToRemove);
            // Disable removal if a pilot is inside or if user lacks access when locked
            var disableRemove = _pilotPresent || !_hasAccess;
            control.SetRemoveDisabled(disableRemove);
            container.AddChild(control);
        }
    }

    public void UpdateEquipmentView(List<NetEntity>? equipment = null)
    {
        UpdateEntityListView<MechEquipmentComponent>(
            equipment,
            EquipmentControlContainer,
            mech => mech.EquipmentContainer.ContainedEntities,
            ent => _ent.GetComponentOrNull<MechEquipmentComponent>(ent)?.Size ?? 1,
            ent => OnRemoveButtonPressed?.Invoke(ent),
            ent => _ent.GetComponentOrNull<UIFragmentComponent>(ent)?.Ui?.GetUIFragmentRoot()
        );
    }

    public void UpdateModuleView(List<NetEntity>? modules = null)
    {
        UpdateEntityListView<MechModuleComponent>(
            modules,
            ModuleControlContainer,
            mech => mech.ModuleContainer.ContainedEntities,
            ent => _ent.GetComponentOrNull<MechModuleComponent>(ent)?.Size ?? 1,
            ent => OnRemoveModuleButtonPressed?.Invoke(ent),
            null
        );
    }
}
